/*! elephant - v0.2.0 - 2014-02-08
* https://github.com/nire0510/elephant
* Copyright (c) 2014 Nir Elbaz; Licensed  */
!function(a,b,c){"use strict";function d(a,d){if(!b.isString(a)||b.isEmpty(a))throw"Object id is illegal";if(d===c&&(d={}),!b.isPlainObject(d))throw"Settings are illegal";return this.id=a.toString(),this.settings=b.extend({},s,d),this.items=[],this}function e(){d.call(this,"Elephant",{})}function f(a,b){d.call(this,a,b)}function g(a,b){d.call(this,a,b)}function h(a,c){this.id=b.uniqueId(),this.timestamps={created:b.now(),sent:null,received:null},this.params=a,this.data=c}function i(a){if("object"!=typeof a)throw"Settings are invalid";for(var c in a)if(a.hasOwnProperty(c))switch(c){case"async":if(b.isBoolean(a[c])===!1)throw'Settings are illegal: "async" must be a boolean';break;case"dataType":if(/xml|script|json|html/.test(a[c])===!1)throw'Settings are illegal: "dataType" must be a either xml, json, html or script';break;case"timeout":if(b.isNumeric(a[c])===!1)throw'Settings are illegal: "timeout" must be a positive integer';break;case"url":if(b.isString(a[c])===!1)throw'Settings are illegal: "url" must be a string';break;case"cache":if(b.isBoolean(a[c])===!1)throw'Settings are illegal: "cache" must be a boolean';break;case"expires":if(b.isNumeric(a[c])===!1)throw'Settings are illegal: "expires" must be a positive integer';break;case"type":if(/GET|POST|PUT|DELETE/.test(a[c])===!1)throw'Settings are illegal: "type" must be a either GET, POST, PUT or DELETE';break;case"process":if(b.isFunction(a[c])===!1)throw'Settings are illegal: "process" callback must be a function'}}function j(a,d){if(!b.isString(a)||b.isEmpty(a))throw"Store id is illegal";if(d===c&&(d={}),!b.isPlainObject(d))throw"Settings are illegal";i(d);var e=new f(a,d);r.addItem(e)}function k(a){r.removeItem(a)}function l(){r.removeAllItems()}function m(a,d,e){if(!b.isString(a)||b.isEmpty(a))throw"Store id is illegal";if(!b.isString(d)||b.isEmpty(d))throw"Query id is illegal";if(e===c&&(e={}),!b.isPlainObject(e))throw"Settings are illegal";i(e);var f=r.getItem("id",a);if(f===c)throw"Store id could not be found";for(var h in e)if(e.hasOwnProperty(h))switch(h){case"success":}var j=new g(d,b.extend(e,f.settings,e));e.url.indexOf("{{inherit}}")>=0&&(e.url=e.url.replace("{{inherit}}",f.settings.url)),f.addItem(j)}function n(a,d){if(!b.isString(a)||b.isEmpty(a))throw"Store id is illegal";if(!b.isString(d)||b.isEmpty(d))throw"Query id is illegal";var e=r.getItem("id",a);if(e===c)throw"Store id could not be found";e.removeItem(d)}function o(a){if(!b.isString(a)||b.isEmpty(a))throw"Store id is illegal";var d=r.getItem("id",a);if(d===c)throw"Store id could not be found";d.removeAllItems()}function p(a,d,e){if(!b.isString(a)||b.isEmpty(a))throw"Store id is illegal";if(!b.isString(d)||b.isEmpty(d))throw"Query id is illegal";if(e===c&&(e={}),!b.isPlainObject(e))throw"Settings are illegal";i(e);var f=r.getItem("id",a);if(f===c)throw"Store id could not be found";var g=f.getItem("id",d);if(g===c)throw"Query id could not be found";e.url&&(e.url=e.url.replace("{{inherit}}",f.settings.url));var j=new h(e.data||{},null);return g.executeQuery(j,e)}function q(a,d){var e,f,g=0;switch(arguments.length){case 0:g=r.countItems();break;case 1:if(!b.isString(a))throw"Store id is illegal";if(e=r.getItem("id",a),e===c)throw"Store id could not be found";g=e.countItems();break;case 2:if(!b.isString(a)||b.isEmpty(a))throw"Store id is illegal";if(!b.isString(d)||b.isEmpty(d))throw"Query id is illegal";if(e=r.getItem("id",a),e===c)throw"Store id could not be found";if(f=e.getItem("id",d),f===c)throw"Query id could not be found";g=f.countItems()}return g}var r,s={expires:3e5,process:null};d.prototype={addItem:function(a){if(!b.isObject(a))throw"Object is illegal";if(this.itemExists(a)===!1)return this.items.push(a),console.log('Item "%s" added to collection',a.id),!0;throw"Item already exists"},removeAllItems:function(){return this.items=[],0},removeItem:function(a){if(!b.isString(a)||b.isEmpty(a))throw"Object id is illegal";var c=this.getIndex(a);return c>=0?(this.items.splice(c,1),console.log('Object "%s" removed from collection',a),!0):(console.warn('Object "%s" hasn\'t been removed from collection (does it exist?)',a),!1)},countItems:function(){return this.items.length},getItem:function(a,d){var e=null,f=this;if(!b.isString(a)||b.isEmpty(a))throw"Property is illegal";return b.each(f.items,function(b,c){return JSON.stringify(c[a])===JSON.stringify(d)?(e=c,!1):void 0}),e||c},getIndex:function(a){var c=this,d=-1;return b.each(c.items,function(b,c){return c.id===a?(d=b,!1):void 0}),d},itemExists:function(a){var c,d=!1,e=this;if(!b.isObject(a))throw"Object is illegal";return b.each(e.items,function(b,e){c=!0;for(var f in a)if(!e.hasOwnProperty(f)||e[f]!==a[f]){c=!1;break}return c===!0?(d=!0,!1):void 0}),d}},e.prototype=Object.create(d.prototype),e.prototype.constructor=e,f.prototype=Object.create(d.prototype),f.prototype.constructor=f,g.prototype=Object.create(d.prototype),g.prototype.constructor=g,g.prototype.executeQuery=function(a,d){if(b.extend(d,this.settings,d),this.settings.cache===!0){var e=this.getItem("params",a.params);if(b.isEmpty(e)===!1){if(b.now()-e.timestamps.received<this.settings.expires){var f=d.success;if(console.log("Serving item from cache..."),f!==c){"function"==typeof f&&(f=[f]);for(var g=0,h=f.length;h>g;g++)"function"==typeof f[g]&&f[g](e.data)}return e.data}this.removeItem(e.id)}}var i=this;return a.timestamps.sent=b.now(),b.ajax(d).done(function(b){"function"==typeof d.process&&(b=d.process(b)),a.data=b,i.addItem(a)}).fail(function(){a=null}).always(function(){null!==a&&(a.timestamps.received=b.now())})},function(){if("function"!=typeof b)throw"jQuery library is required";var d={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},f=0;return b.extend({isBoolean:function(a){return a===!0||a===!1||a&&"object"==typeof a&&"[object Boolean]"===Object.prototype.toString.call(a)||!1},isEmpty:function(a){var c=!0;if(!a)return c;var d=Object.prototype.toString.call(a),e=a.length;return"[object Array]"===d||"[object String]"===d||"[object Arguments]"===d||"[object Object]"===d&&"number"==typeof e&&b.isFunction(a.splice)?!e:b.isObject(a)?"{}"===JSON.stringify(a):c},isObject:function(a){return!(!a||!d[typeof a])},isString:function(a){return"string"==typeof a||a&&"object"==typeof a&&"[object String]"===Object.prototype.toString.call(a)||!1},uniqueId:function(a){var b=++f;return String(a===c?"":a)+b},pluck:function(a,c){var d=[];return b.each(a,function(a,b){b.hasOwnProperty(c)&&d.push(b[c])}),d}}),Object.create||(Object.create=function(){function a(){}return function(b){if(1!==arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return a.prototype=b,new a}}()),a.Elephant=a.Elephant||{create:j,destroy:k,destroyAll:l,register:m,unregister:n,unregisterAll:o,fetch:p,count:q},r=new e,console.log("Elephant is ready"),a.Elephant}()}(window,jQuery),function(a){"use strict";function b(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Object id is illegal";if(void 0===b&&(b={}),!_.isPlainObject(b))throw"Settings are illegal";return this.id=a.toString(),this.settings=_.defaults(b,s),this.items=[],this}function c(){b.call(this,"Elephant",{})}function d(a,c){b.call(this,a,c)}function e(a,c){b.call(this,a,c)}function f(a,b){this.id=_.uniqueId(),this.timestamps={created:_.now(),sent:null,received:null},this.params=a,this.data=b}function g(a){if("object"!=typeof a)throw"Settings are invalid";var b,c;for(var d in a)if(a.hasOwnProperty(d))switch(d){case"async":if(_.isBoolean(a[d])===!1)throw'Settings are illegal: "async" must be a boolean';break;case"format":if(/xml|text|json|html/.test(a[d])===!1)throw'Settings are illegal: "format" must be a either xml, json, html or text';break;case"timeout":if(_.isNumber(a[d])===!1)throw'Settings are illegal: "timeout" must be a positive integer';break;case"endpoint":if(_.isString(a[d])===!1)throw'Settings are illegal: "endpoint" must be a string';break;case"cacheable":if(_.isBoolean(a[d])===!1)throw'Settings are illegal: "cacheable" must be a boolean';break;case"expires":if(_.isNumber(a[d])===!1)throw'Settings are illegal: "expires" must be a positive integer';break;case"method":if(/GET|POST/.test(a[d])===!1)throw'Settings are illegal: "method" must be a either GET or POST';break;case"process":if(_.isFunction(a[d])===!1)throw'Settings are illegal: "process" callback must be a function';break;case"success":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "success" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "success" callbacks must be a function or an array of functions';break;case"error":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "error" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "error" callbacks must be a function or an array of functions';break;case"complete":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "complete" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "complete" callbacks must be a function or an array of functions'}}function h(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(void 0===b&&(b={}),!_.isPlainObject(b))throw"Settings are illegal";g(b);var c=new d(a,b);r.addItem(c)}function i(a){r.removeItem(a)}function j(){r.removeAllItems()}function k(a,b,c){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(void 0===c&&(c={}),!_.isPlainObject(c))throw"Settings are illegal";g(c);var d=r.getItem("id",a);if(void 0===d)throw"Store id could not be found";for(var f in c)if(c.hasOwnProperty(f))switch(f){case"success":}var h=new e(b,_.defaults(c,d.settings));c.endpoint.indexOf("{{inherit}}")>=0&&(c.endpoint=c.endpoint.replace("{{inherit}}",d.settings.endpoint)),d.addItem(h)}function l(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";var c=r.getItem("id",a);if(void 0===c)throw"Store id could not be found";c.removeItem(b)}function m(a){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";var b=r.getItem("id",a);if(void 0===b)throw"Store id could not be found";b.removeAllItems()}function n(a,b,c){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(void 0===c&&(c={}),!_.isPlainObject(c))throw"Settings are illegal";g(c);var d=r.getItem("id",a);if(void 0===d)throw"Store id could not be found";var e=d.getItem("id",b);if(void 0===e)throw"Query id could not be found";c.endpoint&&(c.endpoint=c.endpoint.replace("{{inherit}}",d.settings.endpoint));var h=new f(c.params||{},null);e.executeQuery(h,c)}function o(a){for(var b=0,c=a.length;c>b;b++)n(a[b].storeID,a[b].queryID,a[b].settings)}function p(a,b,c){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";var d=r.getItem("id",a);if(void 0===d)throw"Store id could not be found";var e=d.getItem("id",b);if(void 0===e)throw"Query id could not be found";return c?e.items:_.pluck(e.items,"data")}function q(a,b){var c,d,e=0;switch(_.size(arguments)){case 0:e=r.countItems();break;case 1:if(!_.isString(a))throw"Store id is illegal";if(c=r.getItem("id",a),void 0===c)throw"Store id could not be found";e=c.countItems();break;case 2:if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(c=r.getItem("id",a),void 0===c)throw"Store id could not be found";if(d=c.getItem("id",b),void 0===d)throw"Query id could not be found";e=d.countItems()}return e}var r,s={format:"text",async:!0,timeout:3e4,endpoint:"",cacheable:!0,method:"GET",expires:3e5,success:[],error:[],complete:[],process:null,params:{}};b.prototype={addItem:function(a){if(!_.isObject(a))throw"Object is illegal";if(this.itemExists(a)===!1)return this.items.push(a),console.log('Item "%s" added to collection',a.id),!0;throw"Item already exists"},removeAllItems:function(){return this.items=[],0},removeItem:function(a){if(!_.isString(a)||_.isEmpty(a))throw"Object id is illegal";var b,c=this.countItems();return this.items=_.reject(this.items,{id:a}),b=this.countItems(),c>b?(console.log('Object "%s" removed from collection',a),!0):(console.warn('Object "%s" hasn\'t been removed from collection (does it exist?)',a),!1)},countItems:function(){return this.items.length},getItem:function(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Property is illegal";return _.find(this.items,function(c){return JSON.stringify(c[a])===JSON.stringify(b)})},itemExists:function(a){if(!_.isObject(a))throw"Object is illegal";return _.some(this.items,a)}},c.prototype=_.create(b.prototype,{constructor:c}),d.prototype=_.create(b.prototype,{constructor:d}),e.prototype=_.create(b.prototype,{constructor:e}),e.prototype.executeQuery=function(a,b){function c(a,b){var c=this,d=new t(_.defaults(b,this.settings),a.params);a.timestamps.sent=_.now(),d.execute(function(d){var e,f=b.success,g=b.process;switch(b.format){case"json":e=JSON.parse(d.responseText);break;case"xml":e=d.responseXML;break;default:e=d.responseText}"function"==typeof g&&(e=g(e)),a.data=e,c.addItem(a),"function"==typeof f&&(f=[f]);for(var h=0,i=f.length;i>h;h++)"function"==typeof f[h]&&f[h](a.data)},function(c){var d=b.error;"function"==typeof d&&(d=[d]),a=null;for(var e=0,f=d.length;f>e;e++)"function"==typeof d[e]&&d[e](c)},function(c){null!==a&&(a.timestamps.received=_.now());var d=b.complete;"function"==typeof d&&(d=[d]);for(var e=0,f=d.length;f>e;e++)"function"==typeof d[e]&&d[e](c)})}var d=_.defaults(b,this.settings);try{d.endpoint=_.template(d.endpoint,a.params)}catch(e){throw"Missing endpoint parameters"}if(this.settings.cacheable===!0){var f=this.getItem("params",a.params);if(_.isEmpty(f)===!1)if(_.now()-f.timestamps.received<this.settings.expires){console.log("Serving item from cache...");var g=d.success;"function"==typeof g&&(g=[g]);for(var h=0,i=g.length;i>h;h++)"function"==typeof g[h]&&g[h](f.data)}else this.removeItem(f.id),c.call(this,a,d);else c.call(this,a,d)}else c.call(this,a,d)};var t=function(a,b){this.xhr=null,this.params=b,this.settings={async:!0,endpoint:"",timeout:null,method:"GET"},this.init(a)};t.prototype=function(){var b=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},c=function(a,c,d){if(void 0!==this.xhr&&""!==this.endpoint){var e=b(this.params);switch(this.settings.async===!0&&(this.xhr.timeout=this.settings.timeout),this.xhr.onreadystatechange=function(){switch(this.readyState){case 4:console.log("Request completed"),this.status>=200&&this.status<=299?"function"==typeof a&&a(this):"function"==typeof c&&c(this),"function"==typeof d&&d(this)}},this.settings.method){case"POST":this.xhr.open(this.settings.method,this.settings.endpoint,this.settings.async),this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.setRequestHeader("Connection","close"),this.xhr.send(e);break;default:var f=this.settings.endpoint;""!==e&&f.indexOf(e)<0&&(f+=f.indexOf("?")>=0?"&"+e:"?"+e),this.xhr.open(this.settings.method,f,this.settings.async),this.xhr.send()}}},d=function(){var b=null;if(XMLHttpRequest)try{b=new XMLHttpRequest}catch(c){b=null}else if("undefined"!=typeof a.ActiveXObject)try{b=new a.ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{b=new a.ActiveXObject("Microsoft.XMLHTTP")}catch(d){throw b=!1,new Error("This browser does not support XMLHttpRequest")}}return b},e=function(a){null===this.xhr&&(this.xhr=d(),this.settings=a)};return{execute:c,init:e}}(),function(){if("function"!=typeof _)throw"lodash library is required";a.Elephant=a.Elephant||{create:h,destroy:i,destroyAll:j,register:k,unregister:l,unregisterAll:m,execute:n,executeMany:o,get:p,count:q},r=new c,_.templateSettings={interpolate:/{{([\s\S]+?)}}/g},console.log("Elephant is ready")}()}(window,void 0);
