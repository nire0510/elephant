/*! elephant - v0.1.1 - 2014-01-31
* https://github.com/nire0510/elephant
* Copyright (c) 2014 Nir Elbaz; Licensed  */
!function(a){"use strict";function b(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Object id is illegal";if(void 0===b&&(b={}),!_.isPlainObject(b))throw"Settings are illegal";return this.id=a.toString(),this.settings=_.defaults(b,q),this.items=[],this}function c(){b.call(this,"Elephant",{})}function d(a,c){b.call(this,a,c)}function e(a,c){b.call(this,a,c)}function f(a,b){this.id=_.uniqueId(),this.timestamps={created:_.now(),sent:null,received:null},this.params=a,this.output=b}function g(a){if("object"!=typeof a)throw"Settings are invalid";var b,c;for(var d in a)if(a.hasOwnProperty(d))switch(d){case"async":if(_.isBoolean(a[d])===!1)throw'Settings are illegal: "async" must be a boolean';break;case"format":if(/xml|text|json|html/.test(a[d])===!1)throw'Settings are illegal: "format" must be a either xml, json, html or text';break;case"timeout":if(_.isNumber(a[d])===!1)throw'Settings are illegal: "timeout" must be a positive integer';break;case"endpoint":if(_.isString(a[d])===!1)throw'Settings are illegal: "endpoint" must be a string';break;case"cacheable":if(_.isBoolean(a[d])===!1)throw'Settings are illegal: "cacheable" must be a boolean';break;case"expires":if(_.isNumber(a[d])===!1)throw'Settings are illegal: "expires" must be a positive integer';break;case"method":if(/GET|POST/.test(a[d])===!1)throw'Settings are illegal: "method" must be a either GET or POST';break;case"process":if(_.isFunction(a[d])===!1)throw'Settings are illegal: "process" callback must be a function';break;case"success":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "success" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "success" callbacks must be a function or an array of functions';break;case"error":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "error" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "error" callbacks must be a function or an array of functions';break;case"complete":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "complete" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "complete" callbacks must be a function or an array of functions'}}function h(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(void 0===b&&(b={}),!_.isPlainObject(b))throw"Settings are illegal";g(b);var c=new d(a,b);p.addItem(c)}function i(a){p.removeItem(a)}function j(){p.removeAllItems()}function k(a,b,c){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(void 0===c&&(c={}),!_.isPlainObject(c))throw"Settings are illegal";g(c);var d=p.getItem("id",a);if(void 0===d)throw"Store id could not be found";var f=new e(b,_.defaults(c,d.settings));c.endpoint.indexOf("{{inherit}}")>=0&&(c.endpoint=c.endpoint.replace("{{inherit}}",d.settings.endpoint)),d.addItem(f)}function l(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";var c=p.getItem("id",a);if(void 0===c)throw"Store id could not be found";c.removeItem(b)}function m(a){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";var b=p.getItem("id",a);if(void 0===b)throw"Store id could not be found";b.removeAllItems()}function n(a,b,c){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(void 0===c&&(c={}),!_.isPlainObject(c))throw"Settings are illegal";g(c);var d=p.getItem("id",a);if(void 0===d)throw"Store id could not be found";var e=d.getItem("id",b);if(void 0===e)throw"Query id could not be found";c.endpoint&&(c.endpoint=c.endpoint.replace("{{inherit}}",d.settings.endpoint));var h=new f(c.params||{},null);e.executeQuery(h,c)}function o(a,b){var c,d,e=0;switch(_.size(arguments)){case 0:e=p.countItems();break;case 1:if(!_.isString(a))throw"Store id is illegal";if(c=p.getItem("id",a),void 0===c)throw"Store id could not be found";e=c.countItems();break;case 2:if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(c=p.getItem("id",a),void 0===c)throw"Store id could not be found";if(d=c.getItem("id",b),void 0===d)throw"Query id could not be found";e=d.countItems()}return e}var p,q={format:"text",async:!0,timeout:3e4,endpoint:"",cacheable:!0,method:"GET",expires:3e5,success:[],error:[],complete:[],process:null,params:{}};b.prototype={addItem:function(a){if(!_.isObject(a))throw"Object is illegal";if(this.itemExists(a)===!1)return this.items.push(a),console.log('Item "%s" added to collection',a.id),!0;throw"Item already exists"},removeAllItems:function(){return this.items=[],0},removeItem:function(a){if(!_.isString(a)||_.isEmpty(a))throw"Object id is illegal";var b,c=this.countItems();return this.items=_.reject(this.items,{id:a}),b=this.countItems(),c>b?(console.log('Object "%s" removed from collection',a),!0):(console.warn('Object "%s" hasn\'t been removed from collection (does it exist?)',a),!1)},countItems:function(){return this.items.length},getItem:function(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Property is illegal";return _.find(this.items,function(c){return JSON.stringify(c[a])===JSON.stringify(b)})},itemExists:function(a){if(!_.isObject(a))throw"Object is illegal";return _.some(this.items,a)}},c.prototype=_.create(b.prototype,{constructor:c}),d.prototype=_.create(b.prototype,{constructor:d}),e.prototype=_.create(b.prototype,{constructor:e}),e.prototype.executeQuery=function(a,b){function c(a,b){var c=this,d=new r(_.defaults(b,this.settings),a.params);a.timestamps.sent=_.now(),d.execute(function(d){var e,f=b.success,g=b.process;switch(b.format){case"json":e=JSON.parse(d.responseText);break;case"xml":e=d.responseXML;break;default:e=d.responseText}"function"==typeof g&&(e=g(e)),a.output=e,c.addItem(a),"function"==typeof f&&(f=[f]);for(var h=0,i=f.length;i>h;h++)"function"==typeof f[h]&&f[h](a.output)},function(c){var d=b.error;"function"==typeof d&&(d=[d]),a=null;for(var e=0,f=d.length;f>e;e++)"function"==typeof d[e]&&d[e](c)},function(c){null!==a&&(a.timestamps.received=_.now());var d=b.complete;"function"==typeof d&&(d=[d]);for(var e=0,f=d.length;f>e;e++)"function"==typeof d[e]&&d[e](c)})}var d=_.defaults(b,this.settings);try{d.endpoint=_.template(d.endpoint,a.params)}catch(e){throw"Missing endpoint parameters"}if(this.settings.cacheable===!0){var f=this.getItem("params",a.params);if(_.isEmpty(f)===!1)if(_.now()-f.timestamps.received<this.settings.expires){console.log("Serving item from cache...");var g=d.success;"function"==typeof g&&(g=[g]);for(var h=0,i=g.length;i>h;h++)"function"==typeof g[h]&&g[h](f.output)}else this.removeItem(f.id),c.call(this,a,d);else c.call(this,a,d)}else c.call(this,a,d)};var r=function(a,b){this.xhr=null,this.params=b,this.settings={async:!0,endpoint:"",timeout:null,method:"GET"},this.init(a)};r.prototype=function(){var b=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},c=function(a,c,d){if(void 0!==this.xhr&&""!==this.endpoint){var e=b(this.params);switch(this.settings.async===!0&&(this.xhr.timeout=this.settings.timeout),this.xhr.onreadystatechange=function(){switch(this.readyState){case 4:console.log("Request completed"),this.status>=200&&this.status<=299?"function"==typeof a&&a(this):"function"==typeof c&&c(this),"function"==typeof d&&d(this)}},this.settings.method){case"POST":this.xhr.open(this.settings.method,this.settings.endpoint,this.settings.async),this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.setRequestHeader("Connection","close"),this.xhr.send(e);break;default:var f=this.settings.endpoint;""!==e&&f.indexOf(e)<0&&(f+=f.indexOf("?")>=0?"&"+e:"?"+e),this.xhr.open(this.settings.method,f,this.settings.async),this.xhr.send()}}},d=function(){var b=null;if(XMLHttpRequest)try{b=new XMLHttpRequest}catch(c){b=null}else if("undefined"!=typeof a.ActiveXObject)try{b=new a.ActiveXObject("Msxml2.XMLHTTP")}catch(c){try{b=new a.ActiveXObject("Microsoft.XMLHTTP")}catch(d){throw b=!1,new Error("This browser does not support XMLHttpRequest")}}return b},e=function(a){null===this.xhr&&(this.xhr=d(),this.settings=a)};return{execute:c,init:e}}(),function(){if("function"!=typeof _)throw"lodash library is required";a.Elephant=a.Elephant||{create:h,destroy:i,destroyAll:j,register:k,unregister:l,unregisterAll:m,execute:n,count:o},p=new c,_.templateSettings={interpolate:/{{([\s\S]+?)}}/g},console.log("Elephant is ready")}()}(window,void 0);
