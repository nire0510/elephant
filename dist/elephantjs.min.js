/*! elephantjs - v0.1.0 - 2014-01-08
* https://github.com/nire0510/elephantjs
* Copyright (c) 2014 Nir Elbaz; Licensed  */
var ElephantJS=function(){"use strict";function a(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Object id is illegal";if(void 0===b&&(b={}),!_.isPlainObject(b))throw"Settings are illegal";return this.id=a.toString(),this.settings=_.defaults(b,r),this.items=[],this}function b(){a.call(this,"ElephantJS",{})}function c(b,c){a.call(this,b,c)}function d(b,c){a.call(this,b,c)}function e(a,b){this.id=_.uniqueId(),this.timestamps={created:_.now(),sent:null,received:null},this.params=a,this.output=b}function f(a){if("object"!=typeof a)throw"Settings are invalid";var b,c;for(var d in a)if(a.hasOwnProperty(d))switch(d){case"async":if(_.isBoolean(a[d])===!1)throw'Settings are illegal: "async" must be a boolean';break;case"format":if(/xml|text|json|html/.test(a[d])===!1)throw'Settings are illegal: "format" must be a either xml, json, html or text';break;case"timeout":if(_.isNumber(a[d])===!1)throw'Settings are illegal: "timeout" must be a positive integer';break;case"endpoint":if(_.isString(a[d])===!1)throw'Settings are illegal: "endpoint" must be a string';break;case"cacheable":if(_.isBoolean(a[d])===!1)throw'Settings are illegal: "cacheable" must be a boolean';break;case"expires":if(_.isNumber(a[d])===!1)throw'Settings are illegal: "expires" must be a positive integer';break;case"method":if(/GET|POST/.test(a[d])===!1)throw'Settings are illegal: "method" must be a either GET or POST';break;case"process":if(_.isFunction(a[d])===!1)throw'Settings are illegal: "process" callback must be a function';break;case"success":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "success" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "success" callbacks must be a function or an array of functions';break;case"error":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "error" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "error" callbacks must be a function or an array of functions';break;case"complete":if(_.isArray(a[d])===!1){if(_.isFunction(a[d])===!1)throw'Settings are illegal: "complete" callbacks must be a function or an array of functions'}else for(b=0,c=a[d].length;c>b;b++)if(_.isFunction(a[d][b])===!1)throw'Settings are illegal: "complete" callbacks must be a function or an array of functions'}}function g(){return q.countItems()}function h(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(void 0===b&&(b={}),!_.isPlainObject(b))throw"Settings are illegal";f(b);var d=new c(a,b);q.addItem(d)}function i(a){q.removeItem(a)}function j(){q.removeAllItems()}function k(a,b,c){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(void 0===c&&(c={}),!_.isPlainObject(c))throw"Settings are illegal";f(c);var e=q.getItem("id",a);if(void 0===e)throw"Store id could not be found";c.endpoint.indexOf("{{inherit}}")>=0&&(c.endpoint=c.endpoint.replace("{{inherit}}",e.settings.endpoint));var g=new d(b,_.defaults(c,e.settings));e.addItem(g)}function l(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";var c=q.getItem("id",a);if(void 0===c)throw"Store id could not be found";c.removeItem(b)}function m(a){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";var b=q.getItem("id",a);if(void 0===b)throw"Store id could not be found";b.removeAllItems()}function n(a,b,c,d){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";if(void 0===c&&(c={}),!_.isPlainObject(c))throw"Settings are illegal";if(void 0===d&&(d={}),!_.isPlainObject(d))throw"Parameters are illegal";f(c);var g=q.getItem("id",a);if(void 0===g)throw"Store id could not be found";var h=g.getItem("id",b);if(void 0===h)throw"Query id could not be found";c.endpoint&&(c.endpoint=c.endpoint.replace("{{inherit}}",g.settings.endpoint));var i=new e(d,null);h.executeQuery(i,c)}function o(a){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";var b=q.getItem("id",a);if(void 0===b)throw"Store id could not be found";return b.countItems()}function p(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Store id is illegal";if(!_.isString(b)||_.isEmpty(b))throw"Query id is illegal";var c=q.getItem("id",a);if(void 0===c)throw"Store id could not be found";var d=c.getItem("id",b);if(void 0===d)throw"Query id could not be found";return d.countItems()}var q,r={format:"text",async:!0,timeout:3e4,endpoint:"",cacheable:!0,method:"GET",expires:3e5,success:[],error:[],complete:[],process:null};a.prototype={addItem:function(a){if(!_.isObject(a))throw"Object is illegal";if(this.itemExists(a)===!1)return this.items.push(a),console.log('Item "%s" added to collection',a.id),!0;throw"Item already exists"},removeAllItems:function(){return this.items=[],0},removeItem:function(a){if(!_.isString(a)||_.isEmpty(a))throw"Object id is illegal";var b,c=this.countItems();return this.items=_.reject(this.items,{id:a}),b=this.countItems(),c>b?(console.log('Object "%s" removed from collection',a),!0):(console.warn('Object "%s" hasn\'t been removed from collection (does it exist?)',a),!1)},countItems:function(){return this.items.length},getItem:function(a,b){if(!_.isString(a)||_.isEmpty(a))throw"Property is illegal";return _.find(this.items,function(c){return JSON.stringify(c[a])===JSON.stringify(b)})},itemExists:function(a){if(!_.isObject(a))throw"Object is illegal";return _.some(this.items,a)}},b.prototype=_.create(a.prototype,{constructor:b}),c.prototype=_.create(a.prototype,{constructor:c}),d.prototype=_.create(a.prototype,{constructor:d}),d.prototype.executeQuery=function(a,b){function c(a,b){var c=this,d=new s(_.defaults(b,this.settings),a.params);a.timestamps.sent=_.now(),d.execute(function(d){var e,f=b.success,g=b.process;switch(b.format){case"json":e=JSON.parse(d.responseText);break;case"xml":e=d.responseXML;break;default:e=d.responseText}"function"==typeof g&&(e=g(e)),a.output=e,c.addItem(a),"function"==typeof f&&(f=[f]);for(var h=0,i=f.length;i>h;h++)"function"==typeof f[h]&&f[h](a.output)},function(c){var d=b.error;"function"==typeof d&&(d=[d]),a=null;for(var e=0,f=d.length;f>e;e++)"function"==typeof d[e]&&d[e](c)},function(c){a.timestamps.received=_.now();var d=b.complete;"function"==typeof d&&(d=[d]);for(var e=0,f=d.length;f>e;e++)"function"==typeof d[e]&&d[e](c)})}var d=_.defaults(b,this.settings);try{d.endpoint=_.template(d.endpoint,a.params)}catch(e){throw"Missing endpoint parameters"}if(this.settings.cacheable===!0){var f=this.getItem("params",a.params);if(_.isEmpty(f)===!1)if(_.now()-f.timestamps.received<this.settings.expires){console.log("Serving item from cache...");var g=d.success;"function"==typeof g&&(g=[g]);for(var h=0,i=g.length;i>h;h++)"function"==typeof g[h]&&g[h](f.output)}else this.removeItem(f.id),c.call(this,a,d);else c.call(this,a,d)}else c.call(this,a,d)};var s=function(a,b){this.xhr=null,this.params=b,this.settings={async:!0,endpoint:"",timeout:null,method:"GET"},this.init(a)};return s.prototype=function(){var a=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},b=function(b,c,d){if(void 0!==this.xhr&&""!==this.endpoint){var e=a(this.params);switch(this.settings.async===!0&&(this.xhr.timeout=this.settings.timeout),this.xhr.onreadystatechange=function(){switch(this.readyState){case 4:console.log("Request completed"),this.status>=200&&this.status<=299?"function"==typeof b&&b(this):"function"==typeof c&&c(this),"function"==typeof d&&d(this)}},this.settings.method){case"POST":this.xhr.open(this.settings.method,this.settings.endpoint,this.settings.async),this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),this.xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded"),this.xhr.setRequestHeader("Connection","close"),this.xhr.send(e);break;default:var f=this.settings.endpoint;""!==e&&f.indexOf(e)<0&&(f+=f.indexOf("?")>=0?"&"+e:"?"+e),this.xhr.open(this.settings.method,f,this.settings.async),this.xhr.send()}}},c=function(){var a=null;if(XMLHttpRequest)try{a=new XMLHttpRequest}catch(b){a=null}else if("undefined"!=typeof window.ActiveXObject)try{a=new window.ActiveXObject("Msxml2.XMLHTTP")}catch(b){try{a=new window.ActiveXObject("Microsoft.XMLHTTP")}catch(c){throw a=!1,new Error("This browser does not support XMLHttpRequest")}}return a},d=function(a){null===this.xhr&&(this.xhr=c(),this.settings=a)};return{execute:b,init:d}}(),function(){if("function"!=typeof _)throw"lodash library is required";q=new b,_.templateSettings={interpolate:/{{([\s\S]+?)}}/g},console.log("ElephantJS is ready")}(),{create:h,destroy:i,destroyAll:j,countStores:g,register:k,unregister:l,unregisterAll:m,countQueries:o,execute:n,countRecords:p,print:function(){console.log(q)}}}(void 0);
